# VPN GATEWAY SPEC 042
## CLIENT RESILIENCE VIA ATOMIC AUTH SNAPSHOT (UDP PUSH)

STATUS: AUTHORITATIVE  
NO OPTIONS. NO ALTERNATIVES. FOLLOW EXACTLY.

---

## GOAL

MAKE THE VPN CLIENT RESILIENT.

ONCE THE CLIENT STARTS SUCCESSFULLY, IT MUST **NOT DIE** DUE TO:
- AUTHENTICATION FAILURE
- SERVER RESTART
- TEMPORARY WCF FAILURE
- UDP DATA PLANE FAILURES

THE CLIENT MUST CONTINUE RUNNING AND RECOVER AUTOMATICALLY.

---

## CORE DESIGN PRINCIPLE

### VpnAuthResponse IS THE ATOMIC SESSION SNAPSHOT

```fs
type VpnAuthResponse =
    {
        assignedIp : VpnIpAddress
        serverPublicIp : VpnIpAddress
        sessionId : VpnSessionId
        sessionAesKey : byte[]
    }
```

THIS RECORD IS:

THE SINGLE SOURCE OF TRUTH FOR THE UDP DATA PLANE

ATOMICALLY SWAPPED ON RE-AUTHENTICATION

NEVER PARTIALLY READ

NEVER DECOMPOSED INTO MULTIPLE MUTABLE FIELDS

CLIENT ARCHITECTURE CHANGE (MANDATORY)
1. INTRODUCE A SINGLE MUTABLE SNAPSHOT

THE CLIENT SERVICE MUST OWN EXACTLY ONE MUTABLE VALUE:

```fs
currentAuth : VpnAuthResponse option
```

RULES:

INITIAL VALUE = None

UPDATED ONLY ON SUCCESSFUL AUTHENTICATION

NEVER CLEARED ON TRANSIENT FAILURES

SWAPPED ATOMICALLY (REFERENCE SWAP)

2. UDP DATA PLANE MUST NOT STORE SESSION DATA

THE UDP CLIENT AND ALL UDP LOOPS MUST NOT STORE:

sessionId

sessionAesKey

assignedIp

INSTEAD, THEY MUST RECEIVE:

```fs
getAuth : unit -> VpnAuthResponse option
```

ON EACH SEND / RECEIVE ITERATION:

CALL getAuth()

IF None -> BACKOFF / SKIP

IF Some auth -> USE ONLY THAT SNAPSHOT

NO CACHING. NO COPIES.

3. UDP PLANE IS STARTED ONCE

UDP SEND/RECEIVE LOOPS:

START EXACTLY ONCE

NEVER STOPPED FOR RECONNECTS

NEVER RESTARTED DUE TO AUTH FAILURE OR SERVER RESTART

THEY CONTINUE RUNNING FOREVER AND ADAPT AUTOMATICALLY
TO SNAPSHOT CHANGES.

CLIENT STARTUP BEHAVIOR
StartAsync MUST BE LIGHTWEIGHT

StartAsync MUST:

ENABLE KILL-SWITCH

INITIALIZE currentAuth = None

START A BACKGROUND SUPERVISOR TASK

RETURN Task.CompletedTask IMMEDIATELY

StartAsync MUST NOT:

BLOCK

AUTHENTICATE INLINE

START TUNNEL OR UDP LOOPS INLINE

SUPERVISOR LOOP (BACKGROUND TASK)

THE SUPERVISOR LOOP IS RESPONSIBLE FOR:

AUTHENTICATION

ATTEMPT AUTHENTICATION

ON SUCCESS -> SWAP currentAuth

ON FAILURE -> RETRY WITH BACKOFF (FOREVER)

HEALTH CHECK

PERIODIC WCF HEALTH CHECK (CONTROL PLANE)

INTERVAL: 15–30 SECONDS

BACKOFF UP TO 5 MINUTES

UDP PLANE IS NOT USED FOR HEALTH CHECKING

SESSION EXPIRATION

IF SERVER REPORTS SESSION EXPIRED:

RE-AUTHENTICATE

ATOMICALLY REPLACE currentAuth

DO NOT STOP UDP

SERVER DOWN

IF WCF IS UNREACHABLE:

LOG ONCE

RETRY WITH BACKOFF

DO NOTHING ELSE

WCF HEALTH CHECK METHOD (MANDATORY)

ADD A NEW WCF METHOD:

```fs
pingSession(clientId, sessionId) -> Ok | SessionExpired
```
RULES:

FAST

NO ALLOCATION

CHECKS SERVER REGISTRY ONLY

RETURNS SessionExpired IF SESSION NOT FOUND OR INVALID

TUNNEL AND IP HANDLING

ASSUMPTION (MANDATORY):

assignedIp IS STABLE PER CLIENT

SERVER MUST REISSUE SAME IP FOR SAME CLIENT

THEREFORE:

TUNNEL IS STARTED ONCE

TUNNEL IS NEVER RESTARTED ON RE-AUTH

ROUTES / DNS / KILL-SWITCH PERMITS REMAIN VALID

FAILURE POLICY (STRICT)

THE CLIENT PROCESS MUST ONLY EXIT IF:

EXPLICITLY STOPPED

CRITICAL STARTUP FAILURE (MISSING CONFIG, MISSING KEYS)

THE CLIENT MUST NOT EXIT DUE TO:

AUTH FAILURE

SERVER RESTART

NETWORK PARTITION

WCF TIMEOUTS

UDP ERRORS

LOGGING RULES

LOG STATE TRANSITIONS ONLY

AUTH FAILURE: WARN ONCE, THEN INFO OCCASIONALLY

WCF FAILURES: INFO WITH BACKOFF

NO LOG SPAM

NO PER-PACKET LOGGING

SUMMARY

VpnAuthResponse IS THE ATOMIC SESSION

UDP PLANE USES A GETTER, NOT STORED STATE

SUPERVISOR LOOP CONTROLS AUTH + HEALTH

UDP NEVER RESTARTS

CLIENT NEVER DIES AFTER STARTUP

THIS IS NOT OPTIONAL.
