# VPN GATEWAY SPEC 039 — DETECT PHYSICAL ROUTE AND WRITE APPSETTINGS (WITH DEFAULTS)

## ABSOLUTE RULES (READ FIRST)
- YOU MUST FOLLOW F# camelCase THROUGHOUT ALL F# CODE AND PascalCase THROUGHOUT ALL C# CODE.
- NO COPY/PASTE FROM PREVIOUS OUTPUTS OR OTHER FILES. WRITE CLEAN, PURPOSEFUL CODE.
- DO NOT ADD “OPTION A/B”, DO NOT ADD OPTIONAL FEATURES, DO NOT REFACTOR UNRELATED CODE.
- ALL VPN APPSETTINGS-RELATED LOGIC MUST GO INTO: `C:\GitHub\Softellect\Vpn\Core\AppSettings.fs`
- ALL CLI/COMMAND WORK MUST GO INTO: `C:\GitHub\Softellect\Vpn\ClientAdm\Program.fs`
- YOU MAY MODIFY OTHER FILES ONLY IF REQUIRED TO FIX COMPILATION DUE TO TYPE CHANGES (E.G., NEW FIELDS IN RECORDS). SUCH CHANGES MUST BE MINIMAL WIRING ONLY.

## GOAL
1) ADD TWO NEW CLIENT ACCESS SETTINGS:
- `physicalGatewayIp` (IPv4)
- `physicalInterfaceName` (string)

2) LOAD THEM VIA `loadVpnClientAccessInfo` INTO `VpnClientAccessInfo`, BUT **LOADING MUST NOT FAIL** IF THESE VALUES ARE MISSING FROM `appsettings.json`.
- DEFAULTS:
  - `physicalGatewayIp = Ip4 "192.168.1.1"`
  - `physicalInterfaceName = "Wi-Fi"`

3) ADD A CLIENT ADMIN COMMAND IN `Softellect.Vpn.ClientAdm` THAT:
- DETECTS THE CURRENT PHYSICAL DEFAULT ROUTE (DEFAULT GATEWAY + INTERFACE NAME)
- WRITES/UPDATES THESE TWO VALUES IN `appsettings.json`
- DOES NOT BREAK OTHER SETTINGS IN THE FILE

## DEFINITION OF “PHYSICAL”
THIS IS THE REAL/NON-TUNNEL ADAPTER USED TO REACH THE PUBLIC INTERNET (THE ONE WITH THE DEFAULT ROUTE 0.0.0.0/0).
WE ARE NOT TRYING TO INFER ANYTHING AT CLIENT RUNTIME. RUNTIME ALWAYS READS FROM CONFIG (WITH DEFAULTS IF ABSENT).
ONLY THE ADMIN TOOL TRIES TO DETECT AND WRITE.

---

# PART A — CORE: APPSETTINGS + ACCESS INFO

## A1. UPDATE THE RECORD TYPE
IN `C:\GitHub\Softellect\Vpn\Core\AppSettings.fs`:
- LOCATE THE CLIENT ACCESS INFO TYPE (LIKELY `VpnClientAccessInfo`).
- ADD TWO FIELDS:
  - `physicalGatewayIp : IpAddress`
  - `physicalInterfaceName : string`

## A2. APPSETTINGS KEYS
IN THE SAME FILE, DEFINE THE KEYS UNDER THE EXISTING CLIENT ACCESS SECTION (USE THE EXISTING PATTERN):
- `PhysicalGatewayIp`
- `PhysicalInterfaceName`

THE JSON SHOULD LOOK LIKE THIS (NAMES MUST MATCH YOUR EXISTING SECTION STRUCTURE):
```json
{
  "appSettings": {
    "VpnClientAccessInfo": {
      "physicalGatewayIp": "192.168.2.1",
      "physicalInterfaceName": "Wi-Fi"
    }
  }
}
```
NOTE: THE ACTUAL SECTION PATH MUST MATCH YOUR CURRENT PROJECT CONVENTION. DO NOT INTRODUCE A NEW TOP-LEVEL FORMAT.

## A3. LOAD WITH DEFAULTS (LOAD MUST NOT FAIL)
UPDATE `loadVpnClientAccessInfo` SO THAT:
- IF THE KEYS ARE PRESENT AND VALID -> USE THEM
- IF THE KEYS ARE MISSING -> USE DEFAULTS:
  - `Ip4 "192.168.1.1"`
  - `"Wi-Fi"`
- IF THE KEYS ARE PRESENT BUT INVALID -> LOG WARN AND FALL BACK TO DEFAULTS (DO NOT FAIL LOAD)

IMPLEMENTATION REQUIREMENTS:
- DO NOT CHANGE EXISTING REQUIRED FIELDS SEMANTICS.
- DO NOT TURN THE WHOLE LOAD INTO “BEST EFFORT”; ONLY THESE TWO FIELDS ARE BEST-EFFORT.
- KEEP ERROR TYPES CONSISTENT WITH THE EXISTING PATTERN.

## A4. SAVE/UPDATE HELPERS
IF `AppSettings.fs` ALREADY HAS HELPERS TO SET/UPDATE VALUES IN JSON (E.G., `trySet`), REUSE THEM.
ADD/UPDATE A SINGLE FUNCTION RESPONSIBLE FOR WRITING THESE TWO KEYS, FOR EXAMPLE:
- `tryWritePhysicalNetworkConfig : FileName -> IpAddress -> string -> Result<Unit, AppError>` (ADAPT TO YOUR EXISTING RESULT TYPE)

THIS FUNCTION MUST:
- OPEN `appsettings.json`
- SET/UPSERT `physicalGatewayIp` AND `physicalInterfaceName`
- SAVE BACK

---

# PART B — CLIENT ADM: DETECT + WRITE COMMAND

## B1. ADD A SINGLE NEW COMMAND
IN `C:\GitHub\Softellect\Vpn\ClientAdm\Program.fs`, ADD A COMMAND:
- NAME: `detectPhysicalNetwork`
- IT DOES NOT TAKE ARGUMENTS
- IT READS THE TARGET `appsettings.json` USING THE SAME MECHANISM THE TOOL ALREADY USES (SAME PATH RESOLUTION RULES YOU CURRENTLY HAVE)

OUTPUT (CONSOLE):
- PRINT THE DETECTED `physicalInterfaceName` AND `physicalGatewayIp`
- PRINT SUCCESS/FAILURE OF WRITING TO CONFIG

## B2. DETECTION METHOD (AUTHORITATIVE)
USE ONE OF THESE METHODS (PICK THE FIRST THAT YOU CAN IMPLEMENT WITH YOUR CURRENT REFERENCES; DO NOT ADD NEW PACKAGES):
1) **RUN `netsh`** AND PARSE:
   - COMMAND: `netsh interface ipv4 show route`
   - FIND THE DEFAULT ROUTE: `0.0.0.0/0`
   - EXTRACT:
     - INTERFACE (INDEX OR NAME) AND NEXT HOP (GATEWAY)
   - THEN MAP INTERFACE INDEX TO INTERFACE NAME:
     - COMMAND: `netsh interface ipv4 show interfaces`

2) IF (1) IS IMPOSSIBLE IN YOUR CURRENT CODEBASE, THEN RUN `route print -4` AND PARSE THE “ACTIVE ROUTES” TABLE:
   - DEFAULT ROUTE LINE IS `0.0.0.0          0.0.0.0          <gateway>        <interface ip>   <metric>`
   - DETERMINE INTERFACE NAME BY LOOKING UP THAT INTERFACE IP IN:
     - `netsh interface ipv4 show addresses`

IMPLEMENTATION NOTES:
- PREFER METHOD (1). IT IS MORE STRUCTURED.
- THIS COMMAND MUST BE ROBUST TO LOCALIZATION VARIATIONS AS MUCH AS PRACTICAL:
  - DO NOT DEPEND ON FIXED COLUMN POSITIONS ONLY; USE SPLITTING + PATTERN MATCHING FOR IP TOKENS.
- IF DETECTION FAILS, RETURN AN ERROR AND DO NOT WRITE ANYTHING.

## B3. RUN COMMAND
YOU ALREADY HAVE `RunCommand` / `RunNetsh` IN `C:\GitHub\Softellect\Vpn\Interop\WinTunAdapter.cs`.
FOR THIS TASK:
- DO NOT MODIFY `WinTunAdapter.cs` UNLESS YOU ABSOLUTELY MUST.
- IF YOU NEED A COMMAND RUNNER IN F#, ADD A SMALL LOCAL HELPER IN `ClientAdm\Program.fs` (ProcessStartInfo, capture stdout/stderr).

## B4. WRITE TO APPSETTINGS
AFTER DETECTION:
- CALL THE CORE FUNCTION YOU ADDED IN `AppSettings.fs` TO WRITE THE VALUES.
- ENSURE YOU PRESERVE THE REST OF THE JSON FILE.

---

# PART C — PROPAGATION / REUSE (MINIMAL WIRING ONLY)

## C1. FIX COMPILATION AFTER RECORD CHANGE
BECAUSE `VpnClientAccessInfo` HAS NEW FIELDS, YOU MUST UPDATE ALL CONSTRUCTION SITES.
RULE:
- WHEN YOU CONSTRUCT `VpnClientAccessInfo` IN CODE (NOT VIA JSON), SET:
  - `physicalGatewayIp = Ip4 "192.168.1.1"`
  - `physicalInterfaceName = "Wi-Fi"`
UNLESS YOU ARE ALREADY LOADING FROM `loadVpnClientAccessInfo` (IN WHICH CASE IT IS ALREADY POPULATED).

## C2. REMOVE HARDCODED USE WHERE IT IS OBVIOUS
WHEREVER THE CLIENT TUNNEL CONFIG IS BUILT (E.G., `getTunnelConfig` IN CLIENT RUNTIME CODE), REPLACE:
- `physicalGatewayIp = Ip4 "192.168.2.1"`
- `physicalInterfaceName = "Wi-Fi"`
WITH THE VALUES FROM THE LOADED ACCESS INFO / CONFIG STRUCTURE THAT CONTAINS `VpnClientAccessInfo`.

THIS MUST BE A PURE WIRING CHANGE:
- NO NEW DETECTION LOGIC IN RUNTIME
- NO NEW CONFIG OVERRIDES
- DO NOT CHANGE ROUTING/KILLSWITCH LOGIC BEYOND REPLACING THE SOURCE OF THESE TWO VALUES

---

# ACCEPTANCE CHECKLIST
- BUILD SUCCEEDS.
- CLIENT RUNTIME LOADS EVEN IF `physicalGatewayIp` / `physicalInterfaceName` ARE MISSING FROM `appsettings.json` (DEFAULTS ARE USED).
- `Softellect.Vpn.ClientAdm detectPhysicalNetwork`:
  - PRINTS DETECTED VALUES
  - UPDATES `appsettings.json` WITH THEM
- NO OTHER BEHAVIOR CHANGES OUTSIDE THE REQUIRED WIRING.
